{#
    Embeddable template for forms with card-style sections.
    Use FormSectionType (not FormType) for each group so only those get section options.

    In your FormType:
    $builder->add(
        $builder->create('general', FormSectionType::class, [
            'inherit_data' => true,
            'label' => 'General',
            'section_icon' => 'heroicons:info...',
            'section_description' => 'Description...',
        ])
            ->add('name', TextType::class)
            ->add('email', TextType::class)
    );

    In your template:
    {% embed '@SymkitForm/form/sectioned_form.html.twig' with {form: form} %}
        {% block form_actions %}
            <button type="submit">Save</button>
        {% endblock %}
    {% endembed %}
#}

{# Filter groups that have children (skip empty groups) #}
{% set visible_groups = [] %}
{% for group in form.children %}
    {% if group.children|length > 0 %}
        {% set visible_groups = visible_groups|merge([group]) %}
    {% endif %}
{% endfor %}

{# Generate section IDs from group names #}
{% set section_ids = {} %}
{% for group in visible_groups %}
    {% set section_ids = section_ids|merge({(group.vars.name): 'section-' ~ group.vars.name}) %}
{% endfor %}

<div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6 items-start" 
     data-controller="form--section-nav">
    
    {# ========== STICKY NAVIGATION (hidden on mobile) ========== #}
    <nav class="hidden lg:block w-56 flex-shrink-0 lg:sticky lg:top-24">
        <div class="bg-white dark:bg-gray-800/50 rounded-lg shadow-sm border border-slate-200 dark:border-white/10 overflow-hidden">
            <div class="p-4 bg-slate-50 dark:bg-white/5 border-b border-slate-100 dark:border-white/5">
                <h3 class="text-xs font-bold text-slate-500 dark:text-gray-400 uppercase tracking-wider">Navigation</h3>
            </div>
            <ul class="text-sm" data-form--section-nav-target="navList">
                {% for group in visible_groups %}
                    <li>
                        <a href="#{{ section_ids[group.vars.name] }}" 
                           data-section-id="{{ section_ids[group.vars.name] }}"
                           data-form--section-nav-target="navLink"
                           data-action="click->form--section-nav#scrollTo"
                           class="flex items-center gap-2 px-4 py-3 border-l-2 border-transparent text-slate-600 dark:text-gray-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white transition-colors">
                            {% if group.vars.section_icon is defined and group.vars.section_icon %}
                                {{ ux_icon(group.vars.section_icon, {class: 'w-4 h-4'}) }}
                            {% endif %}
                            {{ group.vars.label }}
                        </a>
                    </li>
                {% endfor %}
                {% block extra_nav_items %}{% endblock %}
            </ul>
        </div>
    </nav>
    
    {# ========== MAIN CONTENT ========== #}
    <div class="flex-1 space-y-6 pb-6">
        {{ form_start(form, {attr: {class: 'space-y-6'}}) }}
        
        {% for group in visible_groups %}
            <section id="{{ section_ids[group.vars.name] }}" 
                     class="scroll-mt-28"
                     data-form--section-nav-target="section">
                <div class="bg-white dark:bg-gray-800/50 rounded-xl shadow-sm border border-slate-200 dark:border-white/10 overflow-visible">
                    <div class="{{ group.vars.section_full_width|default(false) ? 'flex flex-col' : 'lg:grid lg:grid-cols-3 lg:gap-0' }}">
                        {# Section Header #}
                        <div class="{{ group.vars.section_full_width|default(false) ? 'w-full' : 'lg:col-span-1' }} bg-slate-50/80 dark:bg-white/5 p-6 border-b {{ group.vars.section_full_width|default(false) ? '' : 'lg:border-b-0 lg:border-r' }} border-slate-100 dark:border-white/5">
                            <h3 class="text-base font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                                {% if group.vars.section_icon is defined and group.vars.section_icon %}
                                    {{ ux_icon(group.vars.section_icon, {class: 'w-5 h-5 text-slate-500 dark:text-gray-400'}) }}
                                {% endif %}
                                {{ group.vars.label }}
                            </h3>
                            {% if group.vars.section_description is defined and group.vars.section_description %}
                                <p class="mt-1 text-xs text-slate-500 dark:text-gray-400 leading-relaxed">
                                    {{ group.vars.section_description }}
                                </p>
                            {% endif %}
                        </div>
                        
                        {# Form Fields #}
                        <div class="{{ group.vars.section_full_width|default(false) ? 'w-full' : 'lg:col-span-2' }} p-6 space-y-5">
                            {% for field in group.children %}
                                {{ form_row(field) }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </section>
        {% endfor %}
        
        {# ========== BOTTOM STICKY ACTIONS (inside form) ========== #}
        <div class="sticky bottom-4 bg-white dark:bg-gray-800/95 rounded-xl shadow-lg border border-slate-200 dark:border-white/10 backdrop-blur py-4 px-6 flex items-center justify-end gap-3">
            {% block form_actions %}
                <button type="submit"
                    class="inline-flex items-center justify-center gap-2 py-2.5 px-4 rounded-lg bg-slate-900 dark:bg-indigo-600 text-white text-sm font-medium shadow-lg hover:bg-slate-800 dark:hover:bg-indigo-500 transition-all cursor-pointer">
                    {{ ux_icon('heroicons:check-20-solid', {class: 'w-4 h-4'}) }}
                    {{ 'form.action.save'|trans({}, 'SymkitForm') }}
                </button>
            {% endblock %}
        </div>
        
        {{ form_end(form) }}
    </div>
</div>
