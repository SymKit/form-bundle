<div {{ attributes.defaults(stimulus_controller('form--password-visibility')) }} class="relative">
    {# Hidden input for form sync #}
    <input type="hidden" name="{{ name }}" value="{{ password }}" data-model="password" />

    <div class="relative">
        <input type="password" data-form--password-visibility-target="input"
            class="block w-full rounded-md bg-white px-3 py-1.5 pr-10 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:placeholder:text-gray-500 dark:focus:outline-indigo-500"
            placeholder="{{ placeholder }}" data-model="debounce(150)|password" />

        <button type="button"
            class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-500"
            data-action="click->form--password-visibility#toggle">
            <span data-form--password-visibility-target="iconShow">
                {{ ux_icon('heroicons:eye-20-solid', {class: 'h-5 w-5'}) }}
            </span>
            <span data-form--password-visibility-target="iconHide" class="hidden">
                {{ ux_icon('heroicons:eye-slash-20-solid', {class: 'h-5 w-5'}) }}
            </span>
        </button>
    </div>

    {% if showStrength %}
    {% set strength = this.strength %}
    <div class="mt-2">
        <div class="flex h-1 gap-1">
            {% for i in 1..4 %}
            <div class="h-full flex-1 rounded-full transition-all duration-500 {{ i <= strength.score ? (
                        strength.score == 1 ? 'bg-red-500' :
                        strength.score == 2 ? 'bg-orange-500' :
                        strength.score == 3 ? 'bg-yellow-500' :
                        'bg-green-500'
                    ) : 'bg-gray-200 dark:bg-gray-700' }}"></div>
            {% endfor %}
        </div>

        <ul class="mt-3 space-y-1.5">
            {% set rules_config = [
            { key: 'length', text: 'form.password.rule.length'|trans({'%min%': minLength}, 'SymkitForm') },
            { key: 'uppercase', text: 'form.password.rule.uppercase'|trans({}, 'SymkitForm'), enabled: requireUppercase },
            { key: 'number', text: 'form.password.rule.number'|trans({}, 'SymkitForm'), enabled: requireNumbers },
            { key: 'special', text: 'form.password.rule.special'|trans({}, 'SymkitForm'), enabled: requireSpecial }
            ] %}

            {% for rule in rules_config %}
            {% if rule.enabled|default(true) %}
            {% set is_met = attribute(strength.rules, rule.key) %}
            {% set color_class = is_met ? 'text-green-600 dark:text-green-400' : (password != '' ? 'text-red-600
            dark:text-red-400' : 'text-gray-500') %}

            <li class="flex items-center gap-2 text-xs font-medium transition-colors duration-300 {{ color_class }}">
                {% if is_met %}
                {{ ux_icon('heroicons:check-circle-20-solid', {class: 'h-3.5 w-3.5 flex-none'}) }}
                {% elseif password != '' %}
                {{ ux_icon('heroicons:x-circle-20-solid', {class: 'h-3.5 w-3.5 flex-none'}) }}
                {% else %}
                <div class="h-1.5 w-1.5 rounded-full bg-current mx-1 flex-none opacity-40"></div>
                {% endif %}
                <span>{{ rule.text }}</span>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
