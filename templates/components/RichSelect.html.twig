<div {{ attributes.defaults(stimulus_controller('live')).add(stimulus_controller('form--rich-select')) }} class="relative">
    {# Hidden input to sync with Symfony Form #}
    <input type="hidden" name="{{ name }}" value="{{ value }}" data-form--rich-select-target="hiddenInput" data-model="value">

    {# Trigger Button #}
    <button type="button"
        class="relative block w-full cursor-pointer rounded-md bg-white py-1.5 pl-3 pr-10 text-left text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:focus:outline-indigo-500"
        aria-haspopup="listbox" aria-expanded="false" data-action="click->form--rich-select#toggle"
        data-form--rich-select-target="trigger">
        <span class="flex items-center gap-2 truncate">
            {% if value is not null and choiceIcons[this.value]|default(null) %}
            {% set icon = choiceIcons[this.value] %}
            {% if icon is iterable %}
            {{ ux_icon(icon.name, {class: 'h-5 w-5 flex-none ' ~ (icon.class|default('text-gray-400
            dark:text-gray-500'))}) }}
            {% else %}
            {{ ux_icon(icon, {class: 'h-5 w-5 flex-none text-gray-400 dark:text-gray-500'}) }}
            {% endif %}
            {% endif %}
            <span>{{ this.selectedLabel ?: placeholder }}</span>
        </span>
    </button>

    {# Icons (Clear & Chevron) #}
    <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
        {% if not required and value is not empty %}
        <button type="button"
            class="p-1 text-gray-400 hover:text-gray-600 focus:outline-none dark:hover:text-gray-300 mr-1 pointer-events-auto"
            data-action="click->form--rich-select#unselect:stop" aria-label="{{ 'form.component.rich_select.clear_selection'|trans({}, 'SymkitForm') }}">
            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z"
                    clip-rule="evenodd" />
            </svg>
        </button>
        {% endif %}
        <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd"
                d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z"
                clip-rule="evenodd" />
        </svg>
    </div>

    {# Dropdown Menu #}
    <div class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-xl border border-gray-200 focus:outline-none sm:text-sm/6 hidden dark:bg-gray-800 dark:border-gray-700"
        tabindex="-1" role="listbox" data-form--rich-select-target="menu">
        {# Search Input #}
        {% if searchable %}
        <div
            class="sticky top-0 z-10 bg-white px-2 py-1.5 dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700/50">
            <div class="relative">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-2">
                    <svg class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="search"
                    class="block w-full rounded-md bg-white py-1.5 pl-8 pr-3 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:placeholder:text-gray-500 dark:focus:outline-indigo-500"
                    placeholder="{{ 'form.component.rich_select.search_placeholder'|trans({}, 'SymkitForm') }}" data-model="debounce(150)|searchQuery"
                    data-action="keydown->form--rich-select#handleKeydown" data-form--rich-select-target="searchInput">
            </div>
        </div>
        {% endif %}

        <ul class="py-1">
            {% for label, val in this.filteredChoices %}
            {% set isSelected = (val ~ "" == value ~ "") %}
            <li class="group relative cursor-pointer select-none py-2 pl-3 pr-9 text-gray-900 hover:bg-gray-50 dark:text-white dark:hover:bg-gray-700/50 transition-colors {{ isSelected ? 'bg-indigo-50/50 dark:bg-indigo-500/10' : '' }}"
                role="option" data-action="click->form--rich-select#select" data-form--rich-select-value-param="{{ val }}"
                data-form--rich-select-label-param="{{ label }}" data-form--rich-select-target="option">
                <div class="flex items-center gap-3">
                    {% if choiceIcons[val]|default(null) %}
                    {% set icon = choiceIcons[val] %}
                    {% if icon is iterable %}
                    {{ ux_icon(icon.name, {class: 'h-5 w-5 flex-none ' ~ (icon.class|default('text-gray-400
                    dark:text-gray-500 group-hover:text-indigo-600 dark:group-hover:text-indigo-400'))}) }}
                    {% else %}
                    {{ ux_icon(icon, {class: 'h-5 w-5 flex-none text-gray-400 dark:text-gray-500
                    group-hover:text-indigo-600 dark:group-hover:text-indigo-400'}) }}
                    {% endif %}
                    {% endif %}
                    <span
                        class="block truncate {{ isSelected ? 'font-semibold text-indigo-600 dark:text-indigo-400' : 'font-normal text-gray-700 dark:text-gray-300' }} group-hover:text-indigo-600 dark:group-hover:text-indigo-400">
                        {{ label }}
                    </span>
                </div>

                {% if isSelected %}
                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600 dark:text-indigo-400">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z"
                            clip-rule="evenodd" />
                    </svg>
                </span>
                {% endif %}
            </li>
            {% else %}
            <li class="relative cursor-default select-none py-2 px-3 text-gray-500 italic">
                {{ 'form.component.rich_select.no_results'|trans({}, 'SymkitForm') }}
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
